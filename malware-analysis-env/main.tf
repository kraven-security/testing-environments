
resource "proxmox_vm_qemu" "guacamole" {
  name        = "guacamole"
  target_node = "pve"
  clone       = "guacamole-template"
  desc        = "Guacamole Controller"
  full_clone = false
  agent      = 1
  cores      = 2
  sockets    = 1
  cpu        = "host"
  memory     = 4096
  scsihw     = "virtio-scsi-pci"
  os_type    = "ubuntu"

  network {
    bridge = "vmbr0"
    model  = "virtio"
  }

  network {
    bridge = "vmbr5"
    model  = "virtio"
  }

  disks {
    scsi {
      scsi0 {
        disk {
          storage = "disk_images"
          # size cannot be less than the image template (25G)
          size = 25
        }
      }
    }
  }

  connection {
    type     = "ssh"
    user     = "adam"
    password = var.ssh_pass
    host     = self.default_ipv4_address
  }

  # setup network custom information
  provisioner "file" {
    source      = "./01-netplan.yaml"
    destination = "/tmp/00-netplan.yaml"
  }

  provisioner "remote-exec" {
    inline = [
      "echo adam | sudo -S mv /tmp/00-netplan.yaml /etc/netplan/00-netplan.yaml",
      "sudo netplan apply && sudo ip addr add dev ens19 ${self.default_ipv4_address}",
      "ip a s"
    ]
  }
}

resource "proxmox_vm_qemu" "flare-vm" {
  name        = "flare-vm"
  target_node = "pve"
  clone       = "FlareVM-template"
  desc        = "Flare VM Machine"
  full_clone = false
  agent      = 1
  cores   = 2
  sockets = 2
  cpu = "host"
  memory  = 6144
  scsihw = "virtio-scsi-pci"

  network {
    bridge = "vmbr5"
    model  = "e1000"
  }

  disks {
    scsi {
      scsi0 {
        disk {
          storage = "disk_images"
          size = 80
        }
      }
    }
  } 
}

resource "proxmox_vm_qemu" "remnux" {
  name        = "remnux"
  target_node = "pve"
  clone       = "remnux-template"
  desc        = "REMnux Machine"
  full_clone = false
  agent      = 1
  cores   = 2
  sockets = 1
  cpu     = "host"
  memory  = 4096
  scsihw  = "virtio-scsi-pci"
  os_type = "ubuntu"

  network {
    bridge = "vmbr5"
    model  = "virtio"
  }
  disks {
    scsi {
      scsi0 {
        disk {
          storage = "disk_images"
          # size cannot be less than the image template (60G)
          size = 60
        }
      }
    }
  }

  #pool = "offense"
}